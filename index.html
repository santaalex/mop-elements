<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoP Editor - Graph Interaction SDK</title>
    <!-- TW Script for dynamic prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Z-Index Scale (High-Star Best Practice) / ÂõæÂ±ÇÈáèË°®Ê†áÂáÜ */
            --z-base: 0;
            --z-canvas: 100;
            --z-shell: 1000;
            --z-popup: 2000;
            --z-drawer: 5000;
            --z-modal: 8000;
            --z-system: 10000;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #f8fafc;
        }

        #app {
            height: 100vh;
            width: 100vw;
        }

        /* High Star UI Details */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>

    <!-- ‚úÖ Import Maps: Dynamic Path Management (Vite/Skypack Pattern) -->
    <script>
        // üîß Environment Switch: One-line toggle between local and CDN
        const USE_CDN = false; // true = Production CDN, false = Local Development

        // üì¶ Dynamic Import Maps Loader (High-Star Best Practice)
        (async function loadImportMaps() {
            try {
                const configPath = `./config/import-maps.${USE_CDN ? 'cdn' : 'local'}.json`;
                const response = await fetch(configPath);

                if (!response.ok) {
                    throw new Error(`Failed to load Import Maps from ${configPath}`);
                }

                const importMaps = await response.json();

                // Inject Import Map into document
                const script = document.createElement('script');
                script.type = 'importmap';
                script.textContent = JSON.stringify(importMaps, null, 2);
                document.head.appendChild(script);

                console.log(`‚úÖ Import Maps loaded: ${USE_CDN ? 'CDN (Production)' : 'Local (Development)'}`);
                console.log('üìç Module Aliases:', Object.keys(importMaps.imports));
            } catch (error) {
                console.error('‚ùå Failed to load Import Maps:', error);
                console.warn('‚ö†Ô∏è Falling back to relative paths');
            }
        })();
    </script>
</head>

<body>
    <!-- CRITICAL: ID must be 'app' to match Router.js -->
    <div id="app"></div>

    <!-- Import Map: Centralized Dependency Management -->
    <script type="importmap">
    {
        "imports": {
            "./AuthService.js": "./AuthService.js",
            "./MingdaoBaseService.js": "./MingdaoBaseService.js",
            "./config.js": "./config.js",
            
            "mop-viewport": "./ViewportEngine.js",
            "mop-renderer": "./CanvasRenderer.js",
            "mop-lane": "./LaneComponent.js",
            "mop-node": "./NodeComponent.js",
            "mop-edge": "./EdgeComponent.js",
            "mop-interaction-sdk": "./packages/mop-interaction-sdk/HitTest.js",
            "mop-drag-sdk": "./packages/mop-drag-sdk/NodeDragStrategy.js",
            "mop-gizmo-sdk": "./packages/mop-gizmo-sdk/GizmoRenderer.js",
            "mop-selection-strategy": "./packages/mop-gizmo-sdk/strategies/SelectionStrategy.js",
            "mop-editing-strategy": "./packages/mop-gizmo-sdk/strategies/EditingStrategy.js"
        }
    }
    </script>

    <script type="module">
        import { Router } from './Router.js';
        import { LoginView } from './LoginView.js';
        import { DashboardView } from './DashboardView.js';
        import { EditorView } from './EditorView.js';
        import { ProjectService } from './ProjectService.js';

        // LOCAL IMPORT: Gizmo SDK (Patched)
        import { GizmoRenderer } from 'mop-gizmo-sdk';

        import { CanvasRenderer } from 'mop-renderer';
        import { InteractionManager } from './interactions/InteractionManager.js';
        import { ViewportEngine } from 'mop-viewport';
        import { LayoutConfig } from './LayoutConfig.js';

        // Critical: Import Atomic Components to register Custom Elements
        import "mop-viewport";
        import "mop-lane";
        import "mop-node";
        import "mop-edge";
        import "mop-renderer";

        // Initialize Router with View Instances
        const routes = {
            'login': new LoginView(),
            'dashboard': new DashboardView(),
            'editor': new EditorView()
        };

        // Root entry
        const router = new Router(routes);
        window.router = router; // Expose for interactions
    </script>

    <!-- Sidebar Integration -->
    <script type="module">
        import { RightSidebar } from './RightSidebar.js';
        // Initialize as a global instance / ÂàùÂßãÂåñ‰∏∫ÂÖ®Â±ÄÂÆû‰æã
        window.sidebarInstance = new RightSidebar();
        console.log('RightSidebar integrated.');
    </script>
</body>

</html>