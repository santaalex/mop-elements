# MoP 数据模型设计（HAP 工作表草案）

> 版本：v0.1（草案）  
> 说明：字段显示名统一使用中文；`code` / `*_code` / `*_ref` 采用英文作为稳定识别码，供前端与 DSL 使用。

---

## 1. 项目维度（Root）

### 1.1 项目表：`项目`

**用途**：一个记录 = 一个 MoP 项目（对应一个 DSL 根对象）

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 项目名称 | `project_name` | 文本 | 显示用名称，例如「生产制造主流程」 |
| 项目标识 | `project_code` | 文本 | **系统生成/只读**，用于前端与 DSL 的稳定主键（可用记录ID或自动编号） |
| 项目描述 | `project_desc` | 文本多行 | 对项目整体描述（可选） |
| 创建时间 | `created_at` | 日期时间 | 系统自动生成或使用默认创建时间 |
| 版本号 | `dsl_version` | 文本 | 如 `1.0.0`，对应 DSL 版本 |

> 说明：后续所有子表都包含「所属项目 (`project_ref`)」字段，关联到此表；普通用户只需填写「项目名称」，其它字段可自动生成或选填。

---

### 1.2 角色表：`角色资源`

**用途**：统一管理项目中的「执行角色」（如操作工、质检员等），**不包含部门/泳道信息**。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 角色名称 | `role_name` | 文本 | 如「操作工」「质检员」 |
| 角色标识 | `role_code` | 文本 | 如 `role_operator` |
| 数量配置 | `quantity` | 数值 | 在仿真/排产中的可用数量 |
| 单位时间成本 | `cost_per_ms` | 数值 | 用于成本分析 |
| 备注 | `role_note` | 文本多行 | 选填，说明角色用途 |

---

### 1.3 KPI 定义表：`KPI定义`

**用途**：项目级 KPI 字典，定义名称、单位、阈值与可选默认目标。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 指标名称 | `kpi_name` | 文本 | 如「循环时间」「合格率」 |
| 指标标识 | `kpi_code` | 文本 | 如 `kpi_cycle_time` |
| 单位 | `unit` | 文本 | 如 `min`、`%` |
| 默认目标值 | `default_target` | 文本/数值 | 可选，用于节点/步骤未单独配置时的默认值 |
| 预警阈值 | `warning_threshold` | 数值 | 超过变黄 |
| 严重阈值 | `critical_threshold` | 数值 | 超过变红 |
| 极性 | `direction` | 单选 | `lower`=越小越好，`higher`=越大越好 |

---

## 2. L1 全景图（Macro View）

> 说明：一个项目只有一个 L1，全景图不单独建表，直接通过「项目 + L1 泳道 + L1 节点 + L1 连线」表达。

### 2.1 L1 泳道表：`L1泳道`

> 固定五个泳道，从上到下依次为：**客户、管理流程、主业务流程、支持业务流程、供应商**。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 泳道名称 | `lane_name` | 文本 | 固定为：客户 / 管理流程 / 主业务流程 / 支持业务流程 / 供应商 |
| 泳道标识 | `lane_code` | 文本 | 如 `lane_customer`、`lane_management` 等 |
| 显示顺序 | `lane_order` | 数值 | 1~5，自上而下 |
| 起始高度 | `layout_y` | 数值 | 泳道顶部位置 |
| 高度 | `layout_h` | 数值 | 泳道高度，可调 |
| 宽度 | `layout_w` | 数值 | 泳道宽度（通常统一，前端也可用全局常量覆盖） |

---

### 2.2 L1 节点表：`L1节点`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属泳道 | `lane_ref` | 关联 | 指向表 `L1泳道` |
| 节点名称 | `node_name` | 文本 | 如「订单处理」 |
| 节点标识 | `node_code` | 文本 | 如 `l1_node_order` |
| 钻取目标L2 | `drill_down_ref` | 文本 | 存 L2 图的 `l2_code` |
| X坐标 | `layout_x` | 数值 | 画布位置 |
| Y坐标 | `layout_y` | 数值 | 画布位置 |
| 宽度 | `layout_w` | 数值 | 节点宽度 |
| 高度 | `layout_h` | 数值 | 节点高度 |
| 字体大小 | `font_size` | 数值 | 节点标题字号（如 14） |
| 层级深度 | `z_index` | 数值 | 可选；用于前后叠放 |

---

### 2.3 L1 连线表：`L1连线`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 连线标识 | `edge_code` | 文本 | 如 `l1_edge_1` |
| 源节点 | `source_node_ref` | 关联 | 指向表 `L1节点` |
| 目标节点 | `target_node_ref` | 关联 | 指向表 `L1节点` |
| 连线标签 | `edge_label` | 文本 | 如「确认订单」 |
| 源锚点 | `source_anchor` | 单选 | `top` / `right` / `bottom` / `left`，控制从哪一边出线 |
| 目标锚点 | `target_anchor` | 单选 | `top` / `right` / `bottom` / `left`，控制从哪一边入线 |

---

## 3. L2 泳道图（Micro View）

### 3.1 L2 图表：`L2流程图`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属L1节点 | `l1_node_ref` | 关联 | 指向表 `L1节点`（从该节点下钻） |
| 流程名称 | `l2_name` | 文本 | 如「订单处理泳道图」 |
| 流程标识 | `l2_code` | 文本 | 如 `l2_order_processing`（对接 `drill_down_ref`） |
| 备注 | `l2_note` | 文本多行 | 说明用途 |

---

### 3.2 L2 泳道表：`L2泳道`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属L2图 | `l2_ref` | 关联 | 指向表 `L2流程图` |
| 泳道名称 | `lane_name` | 文本 | 如「销售部」 |
| 泳道标识 | `lane_code` | 文本 | 如 `lane_sales` |
| 起始高度 | `layout_y` | 数值 | 泳道顶部位置 |
| 高度 | `layout_h` | 数值 | 泳道高度 |
| 宽度 | `layout_w` | 数值 | 泳道宽度（统一，便于前端布局） |

---

### 3.3 L2 节点表：`L2节点`

> 说明：仅负责节点本身的静态属性（名称、类型、位置、大小等），资源与 KPI 通过子表绑定。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属L2图 | `l2_ref` | 关联 | 指向表 `L2流程图` |
| 所属泳道 | `lane_ref` | 关联 | 指向表 `L2泳道` |
| 节点名称 | `node_name` | 文本 | 如「核对库存」 |
| 节点标识 | `node_code` | 文本 | 如 `l2_act_check` |
| 节点类型 | `node_type` | 单选 | 值如：`activity` / `start` / `end` / `gateway` |
| 网关类型 | `gateway_type` | 单选 | 仅当 `node_type=gateway` 时使用；如 `exclusive` / `parallel` / `inclusive` |
| X坐标 | `layout_x` | 数值 | |
| Y坐标 | `layout_y` | 数值 | |
| 宽度 | `layout_w` | 数值 | 节点宽度 |
| 高度 | `layout_h` | 数值 | 节点高度 |
| 字体大小 | `font_size` | 数值 | 节点标题字号 |

---

### 3.4 L2 节点资源绑定：`L2节点资源绑定`

**用途**：一个 L2 节点可以绑定多个角色及所需人数。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属节点 | `l2_node_ref` | 关联 | 指向表 `L2节点` |
| 角色 | `role_ref` | 关联 | 指向表 `角色资源` |
| 需要人数 | `role_count` | 数值 | 如 1 |

---

### 3.5 L2 节点 KPI 绑定：`L2节点KPI`

**用途**：在活动节点上绑定具体 KPI（目标值 & 实际值），用于红黄绿预警。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属节点 | `l2_node_ref` | 关联 | 指向表 `L2节点` |
| KPI定义 | `kpi_def_ref` | 关联 | 指向表 `KPI定义` |
| 目标值 | `target_value` | 文本/数值 | 如 `10` |
| 实际值 | `actual_value` | 文本/数值 | 如 `12` |
| 数据源ID | `source_ref` | 文本 | 如 `ds_mes` |
| 外部标识 | `external_id` | 文本 | 如 `MES_OP_101` |

---

### 3.6 L2 连线表：`L2连线`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属L2图 | `l2_ref` | 关联 | 指向表 `L2流程图` |
| 连线标识 | `edge_code` | 文本 | 如 `l2_e1` |
| 源节点 | `source_node_ref` | 关联 | 指向表 `L2节点` |
| 目标节点 | `target_node_ref` | 关联 | 指向表 `L2节点` |
| 连线类型 | `edge_type` | 单选 | 如 `smoothstep` / `smart` |
| 源锚点 | `source_anchor` | 单选 | `top` / `right` / `bottom` / `left` |
| 目标锚点 | `target_anchor` | 单选 | `top` / `right` / `bottom` / `left` |

---

## 4. L3 活动详情矩阵（Matrix / SOP & PI）

### 4.1 L3 步骤表：`L3步骤`

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属项目 | `project_ref` | 关联 | 指向表 `项目` |
| 所属L2节点 | `l2_node_ref` | 关联 | 指向表 `L2节点`（被双击的 activity） |
| 步骤名称 | `step_name` | 文本 | 如「系统查询」 |
| 步骤标识 | `step_code` | 文本 | 如 `step_1` |
| 顺序号 | `step_order` | 数值 | 控制矩阵中的排列顺序 |

---

### 4.2 L3 角色步骤明细：`L3角色步骤明细`

**用途**：描述在某个步骤中、某个角色需要遵循的 SOP、过程/质量标准。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属步骤 | `step_ref` | 关联 | 指向表 `L3步骤` |
| 角色 | `role_ref` | 关联 | 指向表 `角色资源` |
| SOP内容 | `sop_content` | 文本多行 | 标准作业程序 |
| 过程标准 | `process_standard` | 文本多行 | 如「需在1分钟内完成」 |
| 质量标准 | `quality_standard` | 文本多行 | 如「数据准确率100%」 |

---

### 4.3 L3 步骤 PI：`L3步骤PI`

**用途**：在「角色-步骤」这一层上定义更细粒度的 PI 指标。

| 字段显示名 | 字段 code | 类型 | 说明 |
| ---------- | --------- | ---- | ---- |
| 所属角色步骤 | `role_step_ref` | 关联 | 指向表 `L3角色步骤明细` |
| PI名称 | `pi_name` | 文本 | 如「录入时效」 |
| PI标识 | `pi_code` | 文本 | 如 `step_kpi_1` |
| 目标值 | `pi_target` | 文本 | 如 `30s` |
| 极性 | `pi_direction` | 单选 | `lower` / `higher` |

---

## 5. 关联关系小结

- 项目维度：
  - `角色资源.project_ref` → `项目`
  - `KPI定义.project_ref` → `项目`
- L1：
  - `L1泳道.project_ref` → `项目`
  - `L1节点.project_ref` → `项目`
  - `L1节点.lane_ref` → `L1泳道`
  - `L1连线.source_node_ref` / `target_node_ref` → `L1节点`
  - `L1节点.drill_down_ref` 对应 `L2流程图.l2_code`
- L2：
  - `L2流程图.project_ref` → `项目`
  - `L2流程图.l1_node_ref` → `L1节点`
  - `L2泳道.l2_ref` → `L2流程图`
  - `L2节点.l2_ref` / `lane_ref` → `L2流程图` / `L2泳道`
  - `L2节点资源绑定.l2_node_ref` → `L2节点`
  - `L2节点资源绑定.role_ref` → `角色资源`
  - `L2节点KPI.l2_node_ref` → `L2节点`
  - `L2节点KPI.kpi_def_ref` → `KPI定义`
  - `L2连线.source_node_ref` / `target_node_ref` → `L2节点`
- L3：
  - `L3步骤.project_ref` → `项目`
  - `L3步骤.l2_node_ref` → `L2节点`
  - `L3角色步骤明细.step_ref` → `L3步骤`
  - `L3角色步骤明细.role_ref` → `角色资源`
  - `L3步骤PI.role_step_ref` → `L3角色步骤明细`

---

> 接下来步骤：  
> 你可以在编辑器中打开本文件 `MoP数据模型设计.md`，我们可以按「表级」或「层级」逐段对这份设计做增删调整，然后再落地到 HAP 的 MOP 应用中。

