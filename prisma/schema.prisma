// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  passwordHash   String
  name           String?
  role           String       @default("USER") // USER, ADMIN
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  projects       Project[]
  licenseKeys    LicenseKey[]
}

model LicenseKey {
  id        String   @id @default(uuid())
  key       String   @unique // The actual license string
  status    String   @default("ACTIVE") // ACTIVE, REVOKED, EXPIRED
  planType  String   @default("TRIAL") // TRIAL, ANNUAL
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  data        String? // JSON string for generic metadata or L1 diagrams
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  l2Diagrams PoolSwimlaneDiagram[]
  processKpis ProcessKPI[]
  taskPis     TaskPI[]
  
  processInstances ProcessInstance[] // Added back-relation
}

model PoolSwimlaneDiagram {
  id              String   @id @default(uuid())
  name            String
  description     String?
  parentProcessId String // ID of the process node in L1 diagram
  data            String? // JSON string for L2 nodes/edges
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// 1. Process Node KPIs (High Level)
model ProcessKPI {
  id             String   @id @default(uuid())
  name           String
  target         String
  unit           String   @default("")
  mingdaoFieldId String? // Binding Key for Mingdao

  nodeId    String // ReactFlow Node ID
  diagramId String

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 2. Task PIs (Low Level SOP)
model TaskPI {
  id             String   @id @default(uuid())
  stepName       String
  roleName       String
  taskDesc       String
  piName         String
  target         String
  mingdaoFieldId String? // Binding Key for Mingdao

  nodeId    String
  diagramId String

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Digital Twin Engine Models ---

// A - The Instance (The "Train" or "Passenger")
model ProcessInstance {
  id        String   @id // External Trace ID (e.g. Order No)
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  status    String   // RUNNING, COMPLETED, SUSPENDED
  
  // Current Position
  currentNodeId String? // The Node ID from ReactFlow
  enterNodeTime DateTime? // When did it arrive at this node?
  
  startTime DateTime
  endTime   DateTime?
  
  logs      ProcessLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// B - The Log (The History Tape for Analysis)
model ProcessLog {
  id         String   @id @default(uuid())
  instanceId String
  instance   ProcessInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  nodeId     String
  action     String   // ENTER, LEAVE, SUSPEND, RESUME
  
  payload    String?  // JSON snapshot of business data at this moment
  operator   String?  // Who did it?
  
  timestamp  DateTime
  duration   Int?     // Time spent in previous node (ms)
}

// C - The Snapshot (The Real-time Dashboard Cache)
model NodeRealtimeStats {
  nodeId       String @id // ReactFlow Node ID
  projectId    String // For filtering
  
  activeCount  Int    // How many instances are currently here?
  avgWaitTime  Float  // Average wait time of current instances (min)
  
  status       String // NORMAL, WARNING, CRITICAL
  
  lastUpdated  DateTime @updatedAt
}
