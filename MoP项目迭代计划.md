## MoP 独立站开发迭代计划（基于 HAP + 纯 HTML/CSS/JS）

版本：v0.1（草案）  
作者：AI 助手 + 桂皮八角  
目标：基于 HAP（MOP 应用）存储 MoP DSL 数据，在前端独立站中实现 L1/L2/L3 流程可视化、KPI 与资源、SOP/PI 展示，并采用《视觉表达CSS》定义的工业深色风格。

---

## 整体目标与范围（MVP）

**MVP 目标：**

- 从 HAP（MOP 应用）读取 MoP 项目数据，在独立前端网站中实现：
  - **L1 全景图**：展示 5 条固定泳道上的流程节点 + 连线；节点可点击下钻到对应 L2。
  - **L2 泳道图**：展示角色/部门泳道、活动节点（含 KPI&资源），连线结构。
  - **L3 矩阵详情**：双击 L2 活动节点，弹出 SOP & PI 详情面板（包含步骤、角色、过程/质量标准、PI）。
- **数据来源统一来自 HAP（MOP/MOP2.0 应用）**，前端只读，不在本地存储业务数据。
- **前端技术栈**：纯 HTML + CSS + 原生 JavaScript（遵循 `hap-frontend-project` Skill 约定）。
- **视觉风格**：严格参考 `视觉表达CSS.md` 中的「工业精密感 + 数字化轻盈感」。

**暂不在 MVP 内的内容（后续迭代预留）：**

- 拖拽建模编辑（ReactFlow 交互建模）
- Token 动画与完整离散事件仿真
- 实时监控大屏（实时 Token 流转）
- 完整权限控制、版本管理、多项目切换

---

## 迭代拆分总览

1. **迭代一：数据模型与 HAP 表结构确定**
   - 产出：`MoP数据模型设计.md`（已完成草案，并与业务方对齐）。
2. **迭代二：HAP 表结构落地（通过 HAP AI 助手 / MCP）**
   - 在 MOP/MOP2.0 应用中创建所有需要的工作表和字段。
3. **迭代三：前端独立站骨架 & HAP 接入**
   - 搭建基础 HTML/CSS/JS 结构，打通 HAP V3 API 数据读取通路。
4. **迭代四：L1/L2/L3 可视化与交互逻辑**
   - 完成三层视图的渲染、下钻、双击弹层交互。
5. **迭代五：视觉表达精细化 & 体验打磨**
   - 将 UI 细化到工业深色、磨砂玻璃、微动效、水位颜色等最佳实践。
6. **迭代六：测试、文档与后续扩展预留**
   - 测试用例、使用手册、后续引入仿真与监控的扩展点设计。

---

## 迭代一：数据模型与 HAP 表结构（已完成草案）

**状态：已完成初稿，并在 `MoP数据模型设计.md` 中沉淀。**

### 1.1 已定义的数据模型（摘要）

- 项目维度：
  - `项目`：`project_name` / `project_code` / `project_desc` / `created_at` / `dsl_version`
  - `角色资源`：执行角色（操作工、质检员…），不含部门/泳道
  - `KPI定义`：项目级 KPI 字典（名称、unit、default_target、warning/critical、direction）
- L1（全景图）：
  - `L1泳道`：5 条固定泳道（客户、管理流程、主业务流程、支持业务流程、供应商）+ 布局信息
  - `L1节点`：流程节点（所属泳道、位置、大小、字体大小、drill_down_ref）
  - `L1连线`：节点之间的连线（source/target + 锚点）
- L2（泳道图）：
  - `L2流程图`：与 L1 节点对应的下钻流程图
  - `L2泳道`：部门/功能泳道 + 布局信息
  - `L2节点`：活动/网关/起止节点（含网关类型、位置、大小、字体）
  - `L2节点资源绑定`：节点与角色的 N:N 关系（角色 + 人数）
  - `L2节点KPI`：节点级 KPI 绑定（定义引用 + target/actual + source_ref/external_id）
  - `L2连线`：与 L1 连线相同的结构（含锚点）
- L3（矩阵/SOP&PI）：
  - `L3步骤`：activity 内部步骤（顺序、标识）
  - `L3角色步骤明细`：角色在步骤中的 SOP、过程标准、质量标准
  - `L3步骤PI`：步骤级 PI 指标（名称、目标值、极性）

### 1.2 与用户对齐的关键设计原则

- **主键原则**：所有记录的唯一主键使用 HAP 系统生成 ID；`*_code` 仅作为业务 alias，不要求用户手动维护唯一性。
- **中文显示名 + 英文 alias**：表单展示用中文，前端/DSL 引用用英文 alias。
- **只增不删**：MVP 阶段尽量避免删除已有字段或表，兼顾后续扩展。
- **L1 仅一张全景图**：通过项目 + 泳道/节点表达，不额外建 L1 图表。

**当前动作：**  
用户已经审阅并对 `MoP数据模型设计.md` 做过第一轮批注与确认，现版本为 v0.1，后续如有业务变更再增量调整。

---

## 迀代二：HAP 表结构落地（通过 HAP AI/MCP）

> 目标：在「MOP 应用 / MOP2.0 后台」中真正建立所有工作表和字段，遵循 MoP 数据模型设计。

### 2.1 建表步骤（推荐路径）

1. **使用 HAP AI 建表助手 + 提示词**
   - 对每张表提供一段清晰的中文 Prompt（已开始编写，例如「项目」「角色资源」「KPI定义」「L1泳道」「L1节点」「L1连线」）。
   - 用户在 HAP 中逐条发送给 AI 建表助手，确认生成的表结构与文档一致。

2. **或使用 MCP 工具自动建表（可选）**
   - 利用 `user-hap-mcp-Mop2.0` Server 下的 `create_worksheet` 工具。
   - 我方可提供 `create_worksheet` 的 JSON 参数模板，用户通过 HAP 的 AI/MCP 触发执行。

### 2.2 表清单（本迭代要完成）

1. 项目维度：
   - 项目（project）
   - 角色资源（roles）
   - KPI定义（kpi_definitions）
2. L1：
   - L1泳道（l1_lanes）
   - L1节点（l1_nodes）
   - L1连线（l1_edges）
3. L2：
   - L2流程图（l2_flows）
   - L2泳道（l2_lanes）
   - L2节点（l2_nodes）
   - L2节点资源绑定（l2_node_roles）
   - L2节点KPI（l2_node_kpis）
   - L2连线（l2_edges）
4. L3：
   - L3步骤（l3_steps）
   - L3角色步骤明细（l3_role_steps）
   - L3步骤PI（l3_step_pis）

### 2.3 验证与对齐方式

- **表级检查**：
  - 每张表的字段与 `MoP数据模型设计.md` 对齐（名称、alias、类型、是否必填）。
- **关系检查**：
  - 任选一个测试项目，手动创建：
    - 1 个项目
    - 对应 5 条 L1 泳道
    - 若干 L1 节点和 L2 流程图、L2 节点
  - 检查关联字段是否正确连通（例如 L1 节点能找到对应的 L2 流程图）。

> **当前状态**：  
> 正在通过 HAP AI 建表助手按表逐个创建中，已提供用于建表的 Prompt 模板（见对话记录与后续文档），待用户逐条发送并实际落表后再锁定版本。

---

## 迭代三：前端独立站骨架 & HAP 接入

> 目标：基于纯 HTML/CSS/JS，搭建独立站框架，并打通 HAP V3 API 数据访问链路。

### 3.1 工程结构（遵循 `hap-frontend-project` Skill）

在 `GoldMineV4` 项目下新增前端目录结构（示例）：

```text
/frontend
  ├─ index.html         # 单页应用入口
  ├─ css/
  │   └─ style.css      # 全局样式，注入视觉表达CSS规范
  ├─ js/
  │   ├─ config.js      # HAP 相关配置（API_BASE_URL、AppKey、Sign、工作表 alias/ID）
  │   ├─ api.js         # 封装 HAP V3 / MCP 请求
  │   └─ main.js        # 入口逻辑：加载数据、渲染 L1/L2/L3、绑定事件
  └─ README.md          # 简要使用说明
```

### 3.2 HAP 接入策略

- **配置层（config.js）**：
  - `API_BASE_URL`：如 `https://api.mingdao.com` 或私有化 `/api` 前缀地址。
  - `HAP_APPKEY` / `HAP_SIGN`：从 MOP 应用的 API 密钥或 MCP URL 中提取。
  - 工作表标识：如 `TABLE_IDS = { project: 'xxx', l1Nodes: 'yyy', ... }` 或使用 `alias`。

- **数据访问层（api.js）**：
  - `fetchRows(worksheetId, options)`：封装通用 POST `/v3/app/worksheets/{id}/rows/list`。
  - `getWorksheetStructure(worksheetId)`：用于检查字段 ID / 类型。
  - 封装 L1/L2/L3 相关的专用方法（如 `loadL1Graph(projectCode)`、`loadL2Flow(l2Code)` 等）。

### 3.3 验证步骤

- 在本地启动一个简单的静态服务器（如 `python -m http.server 8000`）。
- 打开 `http://localhost:8000/frontend/index.html`。
- 在浏览器控制台中验证：
  - 能否通过 API 成功获取「项目」「L1节点」「L2节点」「L3步骤」等数据。
  - 如果返回错误，记录错误信息，调整 config.js 中的 host、AppKey/Sign 或表 ID。

---

## 迭代四：L1/L2/L3 可视化与交互逻辑

> 目标：在独立站中完成 L1/L2/L3 视图的渲染与交互（下钻、双击弹层），基于前端已有的数据访问层。

### 4.1 L1 全景图渲染

- 根据 `L1泳道` + `L1节点` + `L1连线`：
  - 使用 SVG 或绝对定位的 DIV + SVG 线条实现：
    - 五条水平泳道背景（使用 `.card-glass` 风格）。
    - 每个 `L1节点` 绘制为卡片（带圆角、阴影、字体、图标）。
    - 根据 `source_node_ref` / `target_node_ref` + `source_anchor` / `target_anchor` 绘制连线。
- 点击 L1 节点：
  - 根据 `drill_down_ref`（L2 流程标识）加载对应的 L2 流程图数据，并切换视图到 L2 模式。

### 4.2 L2 泳道图渲染

- 使用 `L2流程图` + `L2泳道` + `L2节点` + `L2连线`：
  - 顶层为 L2 流程名称。
  - 垂直方向按 `L2泳道.layout_y / layout_h` 布置泳道背景。
  - 在对应泳道上按 `L2节点.layout_x / layout_y` 绘制 activity/gateway/start/end 节点：
    - activity：矩形卡片 + 节点名称 + 主 KPI 状态标签 + 资源简要信息。
    - gateway：使用不同 icon/样式区分 `exclusive/parallel/inclusive`。
  - 连线绘制与 L1 一致，调用同一套连线绘制函数。
- 交互：
  - 点击节点：高亮显示 + 显示基本信息。
  - 双击 activity 节点：打开 L3 详情面板（见下一小节）。

### 4.3 L3 矩阵详情面板

- 数据来源：`L3步骤` + `L3角色步骤明细` + `L3步骤PI`
- 展现形式：
  - 右侧或居中弹出「磨砂玻璃」面板：
    - 顶部：节点名称 + 所属泳道/角色 + 关键 KPI 当前值/目标值。
    - 主体：以表格/矩阵形式展示：
      - 行：步骤（step）
      - 列：角色（role）
      - 单元格：SOP 内容 + 过程标准 + 质量标准 + PI 列表
- 交互：
  - 支持滚动浏览，关闭按钮/点击遮罩关闭。
  - 后续可支持复制到剪贴板（作为培训资料导出基础）。

### 4.4 验证与测试

- 手动挑选一个项目：
  - 检查 L1 视图是否与 HAP 中的数据位置对应。
  - 点击 L1 节点后，是否正确下钻到对应的 L2 图。
  - 双击 L2 节点，是否展示正确的 L3 内容（与 HAP 中数据一致）。

---

## 迭代五：视觉表达 & 体验打磨

> 目标：将 UI 风格与交互细节打磨到符合「工业精密感 + 数字化轻盈感」的标准。

### 5.1 全局视觉变量注入

- 在 `css/style.css` 中引入 `视觉表达CSS.md` 中的 Design Tokens：
  - 颜色变量：
    - `--color-industrial-dark: #09090b;`
    - `--color-industrial-card: #18181b;`
    - `--color-brand-indigo: #6366f1;`
    - 状态色：`#10b981` / `#f59e0b` / `#ef4444` 等。
  - 阴影与圆角：
    - `--shadow-industrial: 0 10px 40px -15px rgba(0,0,0,0.5);`
    - `--radius-industrial: 0.5rem;`

### 5.2 组件级样式优化

- L1/L2/L3 卡片统一使用：
  - `.card-glass`：`background: rgba(24,24,27,0.8); backdrop-filter: blur(8px); border: 1px solid rgba(63,63,70,0.4);`
  - 字体：`Inter`（UI）+ `Geist Mono / JetBrains Mono`（数值）。
- 状态标签（KPI 灯）：
  - 使用类似 `.status-green` 样式：
    - 文本颜色：主色（如 `#10b981`）
    - 背景：低饱和度透明色（`rgba(16,185,129,0.1)`）
    - 内描边：`box-shadow: inset 0 0 0 1px rgba(16,185,129,0.2)`。

### 5.3 动效与交互反馈

- 进入/切换视图：
  - 使用 `transition`/`animation` 实现轻量 `slide-in-from-bottom` + `fade-in`。
- 节点 hover / click：
  - `transform: scale(0.98~1.02)` + 轻微阴影变化，体现「系统已响应」。
- 弹层：
  - 渐入/渐出动画，背景蒙版使用渐变 + 模糊，保持工业深色质感。

### 5.4 可用性与细节

- 空状态（无数据）：
  - 提供清晰、人性化提示（例如：「当前项目尚未配置 L2 流程，请先在后台添加」）。
- 错误提示：
  - 将 HAP API 错误信息通过统一的提示条展示（顶部/右上角 toast），避免打断用户。

---

## 迭代六：测试、文档与扩展路线

### 6.1 测试计划（MVP）

- 单元测试（以 JS 函数为主）：
  - DSL 解析函数：L1/L2/L3 数据结构转换为前端渲染模型。
  - KPI 状态计算：根据 `actual` / `target` / 阈值计算颜色。
- 手工测试用例：
  - 创建一个示例项目，从 L1 → L2 → L3 完整走一遍，验证所有链接与渲染。
  - 断网/接口错误场景下的降级表现。

### 6.2 文档输出

- `frontend/README.md`：
  - 本地启动方式
  - 与 HAP 的集成方式（如何配置 AppKey/Sign）
  - 如何接入新的 MOP 项目/应用
- `MoP数据模型设计.md`：
  - 后续修改需版本号递增（v0.2、v0.3…），保证数据兼容性。

### 6.3 后续扩展（非本轮实现，预留接口）

- 引入 React + ReactFlow 实现可视化建模与拖拽编辑，前后端通过 DSL 同步。
- 引入离散事件仿真（基于 L2/L3 定义的处理时间、资源约束），在前端展示 Token 动画与瓶颈热力图。
- 打通实时数据接入（MES/ERP），在 L2/L3 视图中实时刷新 KPI 显示。

---

## 协作约定与每次迭代前的说明方式

每次我在开始一个新迭代或关键子任务前，会明确说明：

1. **这次要做什么**：例如「在前端实现 L1 节点渲染与点击下钻逻辑」。
2. **为什么这么做**：它解决哪一部分问题，支撑后面哪一步。
3. **会改动哪些文件 / 表**：
   - 代码文件（如 `js/main.js`、`css/style.css`）
   - 可能影响的 HAP 表（如果有的话，会提前说明，不会直接在 HAP 上随意修改）
4. **你如何测试**：
   - 在前端页面上点击哪些位置
   - 在 HAP 后台检查哪些项目/表/字段
   - 预期行为（例如「点击 L1 节点 A 后，应自动切换到展示 L2：订单处理泳道图，并高亮对应的起始节点」）

你可以随时在 `MoP数据模型设计.md` 或本文件上继续加自己的批注，我会以这两个文档作为本项目的「真相来源」，所有设计/实现都会先在文档里对齐再动手实现。  

